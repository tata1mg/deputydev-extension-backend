services:
  deputydev-postgres:
    image: postgres:16
    container_name: deputydev-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: deputydev-postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d deputydev-postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  deputydev-redis:
    image: redis/redis-stack:latest
    container_name: deputydev-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  deputydev-localstack:
    image: localstack/localstack:latest
    container_name: deputydev-localstack
    restart: unless-stopped
    command: >
      sh -c "
        docker-entrypoint.sh &
        while ! curl -fsS http://localhost:4566/_localstack/health >/dev/null 2>&1; do sleep 1; done;
        awslocal s3 mb s3://deputydev --region ap-south-1 || echo 'Bucket already exists';
        echo 'S3 bucket setup complete';
        wait
      "
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEBUG=1
      - AWS_DEFAULT_REGION=ap-south-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - LS_LOG=trace
    volumes:
      - localstack_data:/var/lib/localstack
      - "/var/run/docker.sock:/var/run/docker.sock"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:4566/_localstack/health | grep -q 'services' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # If you want to run deputydev-binary inside Compose, enable this service.
  # If you already run it on your host at port 8001, you can comment this out.
  deputydev-binary:
    build:
      context: ../deputydev-binary
      dockerfile: Dockerfile
      target: runtime
    # image: deputydev-binary:local
    platform: linux/amd64
    container_name: deputydev-binary
    ports:
      - "8001:8001"
    volumes:
      - "/home/satyam-kumar/projects:/home/satyam-kumar/projects"
    depends_on:
      deputydev-extension-backend:
        condition: service_healthy  
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8001/ping >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  deputydev-auth:
    build:
      context: ../deputydev-auth
      dockerfile: Dockerfile
      target: runtime
      args:
        SERVICE_NAME: deputydev-auth
    platform: linux/amd64
    container_name: deputydev-auth
    ports:
      - "9355:9355"
    environment:
      - DATABASE_URL=postgres://postgres:password@deputydev-postgres:5432/deputydev-postgres?sslmode=disable
    command: >
      sh -c "
        dbmate up &&
        python3 -m app.service
      "
    volumes:
      - ../deputydev-auth/db:/db
    depends_on:
      deputydev-postgres:
        condition: service_healthy
      deputydev-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9355/ping >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  deputydev-extension-backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
      args:
        SERVICE_NAME: deputydev-extension-backend
    platform: linux/amd64
    container_name: deputydev-extension-backend
    ports:
      - "8084:8084"
    environment:
      - DATABASE_URL=postgres://postgres:password@deputydev-postgres:5432/deputydev-postgres?sslmode=disable
    command: >
      sh -c "
        dbmate up &&
        python3 -m app.service
      "
    volumes:
      - ./db:/db
    depends_on:
      deputydev-postgres:
        condition: service_healthy
      deputydev-redis:
        condition: service_healthy
      deputydev-localstack:
        condition: service_healthy
      deputydev-auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8084/ping >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  pg_data:
  redis_data:
  localstack_data: